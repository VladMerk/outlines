from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import chain as as_runnable

from llms import llm
from models import Outline
from states import ArticleState

# outline_prompt = ChatPromptTemplate.from_messages(
#     [
#         (
#             "system",
#             "–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å —ç–∫—Å–ø–µ—Ä—Ç–æ–º –≤ –æ–±–ª–∞—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏—Ö –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤."
#             "–í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏ –ø–æ —Ç–µ–º–µ, –ø—Ä–µ–¥–æ—Å—Ç–≤–ª–µ–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."
#             " –°—Ç–∞—Ç—å—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–≥–æ —á–∏—Ç–∞—Ç–µ–ª—è —Å –æ–ø—ã—Ç–æ–º –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö –∏ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–∞—Ö, —Å—Ç—Ä–µ–º—è—â–µ–≥–æ—Å—è —É–≥–ª—É–±–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –∏ –≤–æ—Å–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã."
#             " –ò–∑–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—Å–µ–æ–±—ä–µ–º–ª—é—â–∏–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ –∏ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. "
#             "–ï—Å–ª–∏ —Å—Ç–∞—Ç—å—è –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ —è–∑—ã–∫–∞–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∫–∞–∫–∏—Ö —Ç–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, —Ç–æ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑–¥–µ–ª —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞."
#             "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∞—Ç—å–∏ –¥–æ–ª–∂–Ω—ã –≤–∫–ª—é—á–∞—Ç—å –≤–≤–µ–¥–µ–Ω–∏–µ, –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –∏ –∫—Ä–∞—Ç–∫–∏–µ –≤—ã–≤–æ–¥—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Ä–∞–∑–¥–µ–ª—É(–∑–∞–∫–ª—é—á–µ–Ω–∏–µ), –∞ —Ç–∞–∫–∂–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã."
#             "–î–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç–∞–º –≥–¥–µ –Ω—É–∂–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç Markdown."
#             "–ï—Å–ª–∏ —Ç–µ–º–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –≤–∫–ª—é—á–∞–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏. –ï—Å–ª–∏ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω, —Ç–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ —Ç–æ–ª—å–∫–æ —è–∑—ã–∫ Python."
#             "–ï—Å–ª–∏ —Ç–µ–º–∞ –∫–∞—Å–∞–µ—Ç—Å—è –∏–∑—É—á–µ–Ω–∏—è –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤, –ø—Ä–∏–≤–æ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —è–∑—ã–∫–æ–≤—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ —Å–∏—Ç—É–∞—Ü–∏–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è."
#             "–†–∞–Ω–µ–µ –¥—Ä—É–≥–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –±—ã–ª –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Å–µ–∫—Ü–∏–π —Å—Ç–∞—Ç—å–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
#         ),
#         ("user", "–¢–µ–º–∞: {topic}\n\n{sections}"),
#     ]
# )

outline_prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "–í—ã ‚Äì —ç–∫—Å–ø–µ—Ä—Ç –≤ –æ–±–ª–∞—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏—Ö –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤."
            "\n\n### üìù –í–∞—à–∞ –∑–∞–¥–∞—á–∞:"
            " –ù–∞–ø–∏—Å–∞—Ç—å **—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏** –ø–æ —Ç–µ–º–µ, –∑–∞–¥–∞–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."
            " **–°—Ç–∞—Ç—å—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤–∑—Ä–æ—Å–ª–æ–≥–æ —á–∏—Ç–∞—Ç–µ–ª—è** —Å –æ–ø—ã—Ç–æ–º –≤ –ò–¢ –∏ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–∞—Ö, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—Ç —É–≥–ª—É–±–∏—Ç—å –∑–Ω–∞–Ω–∏—è –∏ –≤–æ—Å–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã."
            "\n\n### üîç –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:"
            "- **–ò–∑–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–º**, —Å –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏."
            "- **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Markdown –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** (–∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –∫–æ–¥)."
            "- **–ï—Å–ª–∏ —Ç–µ–º–∞ –∫–∞—Å–∞–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è**, –≤–∫–ª—é—á–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ —Å —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è–º–∏."
            " –ï—Å–ª–∏ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Python."
            "- **–ï—Å–ª–∏ —Ç–µ–º–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–º–∏ —è–∑—ã–∫–∞–º–∏**, –ø—Ä–∏–≤–æ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —è–∑—ã–∫–æ–≤—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ –æ–±—ä—è—Å–Ω—è–π—Ç–µ –∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç."
            "\n\n### üèó –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∞—Ç—å–∏:"
            "1. –í–≤–µ–¥–µ–Ω–∏–µ ‚Äì –≤–≤–æ–¥–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ–º—ã, –∑–∞—á–µ–º —ç—Ç–æ –≤–∞–∂–Ω–æ."
            "2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã ‚Äì —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤."
            "3. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ ‚Äì –∫—Ä–∞—Ç–∫–æ–µ –ø–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤ + —Å—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–ø. –º–∞—Ç–µ—Ä–∏–∞–ª—ã."
            "\n\n### üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–¥—Ç–µ–º:"
            "–†–∞–Ω–µ–µ –¥—Ä—É–≥–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –±—ã–ª –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω **—Å–ø–∏—Å–æ–∫ –ø–æ–¥—Ç–µ–º** —Å—Ç–∞—Ç—å–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."
            " **–í—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**, –Ω–æ –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ç–µ–º—ã, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ."
            "\n\n–¢–µ–ø–µ—Ä—å **—Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏** —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.",
        ),
        (
            "user",
            "üìù **–¢–µ–º–∞ —Å—Ç–∞—Ç—å–∏:** {topic}\n\nüìå **–°–ø–∏—Å–æ–∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–¥—Ç–µ–º:**\n{sections}",
        ),
    ]
)


@as_runnable
async def get_outline(state: ArticleState):
    outline_chain = outline_prompt | llm.with_structured_output(Outline)
    outline = Outline.model_validate(await outline_chain.ainvoke({"topic": state["topic"], "sections": state["sections"]}))  # type: ignore

    return {**state, "sections": outline.sections}
