from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import chain as as_runnable

from llms import llm
from models import Outline
from states import ArticleState

outline_prompt = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            "–í—ã ‚Äì —ç–∫—Å–ø–µ—Ä—Ç –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö, —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏–∏ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤."
            "\n\n### üìù –í–∞—à–∞ –∑–∞–¥–∞—á–∞:"
            " –ù–∞–ø–∏—Å–∞—Ç—å **–ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç—å—é**, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –ø–æ–¥—Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –ø–µ—Ä–µ–¥–∞–Ω—ã."
            "\n\n### üîç –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:"
            "- **–°—Ç–∞—Ç—å—è –¥–æ–ª–∂–Ω–∞ —á–µ—Ç–∫–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø–æ–¥—Ç–µ–º** (–∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!)."
            "- **–ù–µ –ø–∏—à–∏—Ç–µ –ª–∏—à–Ω–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤, –Ω–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤–≤–æ–¥–Ω—ã—Ö —Ñ—Ä–∞–∑**, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏—Å—å."
            "- **–§–æ—Ä–º–∞—Ç Markdown:** —á–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å–ø–∏—Å–∫–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)."
            "- **–ï—Å–ª–∏ —Ç–µ–º–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏.**"
            "\n\n### üéØ –ö–∞–∫ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—å—é:"
            "1. **–ö–∞–∂–¥–∞—è –ø–æ–¥—Ç–µ–º–∞ ‚Äì —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª**."
            "2. **–ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ–¥—Ç–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã** (–æ–Ω–∏ —É–∂–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã)."
            "3. **–ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ —Å–µ–∫—Ü–∏–∏**."
            "\n\n–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ **–ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç—å—é –ø–æ –¥–∞–Ω–Ω–æ–π —Ç–µ–º–µ**, —Å–ª–µ–¥—É—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º –ø–æ–¥—Ç–µ–º–∞–º.",
        ),
        (
            "user",
            "üìù **–¢–µ–º–∞ —Å—Ç–∞—Ç—å–∏:** {topic}\n\nüìå **–°–ø–∏—Å–æ–∫ –ø–æ–¥—Ç–µ–º (—Ä–∞–∑–¥–µ–ª–æ–≤ —Å—Ç–∞—Ç—å–∏):**\n{sections}",
        ),
    ]
)


@as_runnable
async def get_outline(state: ArticleState):
    outline_chain = outline_prompt | llm.with_structured_output(Outline)
    outline = Outline.model_validate(
        await outline_chain.ainvoke({"topic": state["topic"], "sections": state["sections"]})
        )  # type: ignore

    return {**state, "sections": outline.sections}
